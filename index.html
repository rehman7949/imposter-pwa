<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Imposter – Partyspiel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f5efe6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
  <style>
    :root{
      --bg:#f5efe6;      /* heller Beigeton */
      --text:#111111;    /* schwarze Schrift */
      --muted:#5a5a5a;
      --card:#fffaf2;    /* helles Karten-Beige */
      --line-red:#d13b3b; /* elegante rote Linie */
      --line-green:#1d9a6c; /* elegante grüne Linie */
      --border:#e8dcc6;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .wrap{ max-width:980px; margin:0 auto; padding: max(20px, env(safe-area-inset-top)) 16px 24px }
    /* elegante Linien */
    .ribbon{ height:8px; background:
      linear-gradient(90deg, var(--line-red) 0 50%, var(--line-green) 50% 100%); border-radius:999px; opacity:.8 }
    .ribbon.thin{ height:4px; opacity:.9; }
    header{ display:flex; align-items:center; gap:12px; margin:12px 0 8px }
    .logo{
      width:44px; height:44px; border-radius:12px;
      background: var(--bg);
      border:3px solid var(--line-red);
      display:grid; place-items:center; font-weight:900; font-size:18px; color:var(--line-red);
    }
    h1{ font-size:clamp(22px, 4.8vw, 34px); margin:0 }
    .sub{ color:var(--muted); font-size:14px }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:18px; margin:16px 0; box-shadow: 0 6px 24px rgba(0,0,0,.06);
    }
    label{ display:block; font-weight:700; margin:8px 0 6px }
    input,select,button{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text); font-size:15px;
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .row > *{ flex:1 1 240px }
    .btn{
      background:#111; color:#fff; border:none; cursor:pointer; font-weight:800; letter-spacing:.2px;
      transition: transform .07s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ filter: grayscale(1) opacity(.6); cursor:not-allowed }
    .btn-outline{ background:#fff; border:1px solid var(--border); }
    .muted{ color:var(--muted) }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px }
    .player-tag{ background:#fff; border:1px dashed var(--border); padding:10px 12px; border-radius:12px }
    .big{ font-size: clamp(26px, 6vw, 46px); font-weight:900; letter-spacing:.5px; margin: 16px 0 }
    .center{ text-align:center }

    /* Swipe-Reveal-Karte */
    .reveal-wrap{ position:relative; height:210px; border-radius:16px; overflow:hidden; background:#fff; border:1px solid var(--border) }
    .reveal-content{ position:absolute; inset:0; display:grid; place-items:center; padding:16px }
    .reveal-scrim{
      position:absolute; inset:0; background:var(--card); border-top:6px solid var(--line-green);
      display:flex; align-items:flex-end; justify-content:center; padding:12px;
      transform: translateY(0); touch-action:none; cursor:grab;
      transition: transform .18s ease;
    }
    .scrim-handle{ width:54px; height:6px; background:#ccc; border-radius:999px; margin-bottom:10px }
    .scrim-label{ font-size:13px; color:var(--muted); margin-bottom:12px }
    .kicker{ font-size:12px; text-transform:uppercase; letter-spacing:.18em; color:#666 }

    /* RTL Support */
    [dir="rtl"] .row{ flex-direction: row-reverse }
    [dir="rtl"] select, [dir="rtl"] input{ direction: rtl }

    footer{ margin-top:20px; color:var(--muted); font-size:12px }
  </style>
</head>
<body>
  <div class="ribbon"></div>
  <div class="wrap">
    <header>
      <div class="logo">I</div>
      <div>
        <h1>Imposter</h1>
        <div class="sub">Social-Deduction Partyspiel • PWA</div>
      </div>
    </header>
    <div class="ribbon thin"></div>

    <div id="app"></div>

    <footer>
      <div class="kicker">Installation</div>
      <div class="muted">Auf dem iPhone über <b>Teilen → „Zum Home-Bildschirm“</b> hinzufügen.</div>
    </footer>
  </div>

  <script>
  (function(){
    // ---------- Internationalisierung ----------
    const i18n = {
      de: {
        start_title: "Willkommen",
        start_sub: "Wähle Sprache & Kategorie",
        language: "Sprache",
        category: "Kategorie",
        cat_islamic: "Islamische Begriffe",
        cat_general: "Allgemeine Begriffe",
        continue: "Weiter",
        lobby_title: "Lobby",
        players_hint: "3–12 Spieler · 1 Imposter",
        add_player: "Spieler hinzufügen",
        name_placeholder: "Name eingeben...",
        discussion_secs: "Diskussion (Sekunden)",
        rounds: "Runden",
        start_game: "Spiel starten",
        reveal_title: "Rollen zeigen",
        pass_device_to: "Gerät zu <b>{name}</b> geben",
        show_word: "Wort anzeigen",
        done: "Fertig",
        swipe_up: "Karte hochziehen zum Anzeigen",
        you_are_imposter: "⚠️ Du bist der Imposter!",
        discuss_title: "Diskussion",
        go_vote: "Zur Abstimmung",
        early_vote: "Vorzeitig zur Abstimmung",
        vote_title: "Abstimmung",
        choose_sus: "— wählt verdächtig —",
        finish_vote: "Abstimmung abschließen",
        result_title: "Ergebnis",
        accused: "Beschuldigt",
        imposter: "Imposter",
        crew_wins: "Crew gewinnt 🎉",
        imposter_wins: "Imposter gewinnt 😈",
        play_again: "Nochmal spielen",
        new_lobby: "Neue Lobby",
        starter: "Starter",
        begin_prompt: "Beginnen muss: <b>{name}</b>"
      },
      en: {
        start_title: "Welcome",
        start_sub: "Choose language & category",
        language: "Language",
        category: "Category",
        cat_islamic: "Islamic terms",
        cat_general: "General terms",
        continue: "Continue",
        lobby_title: "Lobby",
        players_hint: "3–12 players · 1 impostor",
        add_player: "Add player",
        name_placeholder: "Enter name...",
        discussion_secs: "Discussion (seconds)",
        rounds: "Rounds",
        start_game: "Start game",
        reveal_title: "Reveal",
        pass_device_to: "Pass device to <b>{name}</b>",
        show_word: "Show word",
        done: "Done",
        swipe_up: "Pull card up to reveal",
        you_are_imposter: "⚠️ You are the impostor!",
        discuss_title: "Discussion",
        go_vote: "Go to voting",
        early_vote: "Go to voting early",
        vote_title: "Voting",
        choose_sus: "— choose suspicious —",
        finish_vote: "Finish voting",
        result_title: "Result",
        accused: "Accused",
        imposter: "Impostor",
        crew_wins: "Crew wins 🎉",
        imposter_wins: "Impostor wins 😈",
        play_again: "Play again",
        new_lobby: "New lobby",
        starter: "Starter",
        begin_prompt: "Starting player: <b>{name}</b>"
      },
      ar: {
        start_title: "مرحبًا",
        start_sub: "اختر اللغة والفئة",
        language: "اللغة",
        category: "الفئة",
        cat_islamic: "مصطلحات إسلامية",
        cat_general: "مصطلحات عامة",
        continue: "متابعة",
        lobby_title: "الردهة",
        players_hint: "٣–١٢ لاعبين · محتال واحد",
        add_player: "إضافة لاعب",
        name_placeholder: "أدخل الاسم...",
        discussion_secs: "المناقشة (بالثواني)",
        rounds: "الجولات",
        start_game: "ابدأ اللعبة",
        reveal_title: "إظهار الأدوار",
        pass_device_to: "أعطِ الجهاز إلى <b>{name}</b>",
        show_word: "اعرض الكلمة",
        done: "تم",
        swipe_up: "اسحب البطاقة للأعلى للكشف",
        you_are_imposter: "⚠️ أنت المحتال!",
        discuss_title: "المناقشة",
        go_vote: "اذهب للتصويت",
        early_vote: "اذهب للتصويت الآن",
        vote_title: "التصويت",
        choose_sus: "— اختر المشتبه —",
        finish_vote: "إنهاء التصويت",
        result_title: "النتيجة",
        accused: "المتهم",
        imposter: "المحتال",
        crew_wins: "فاز الفريق 🎉",
        imposter_wins: "فاز المحتال 😈",
        play_again: "اللعب مجددًا",
        new_lobby: "ردهة جديدة",
        starter: "البادئ",
        begin_prompt: "سيبدأ: <b>{name}</b>"
      }
    };

    // ---------- Themenpools ----------
    // Platzhalter für islamische Begriffe – HIER Deine Liste einfügen:
    const TOPICS_ISLAMIC = [
      // { common:"", imposter:"" },
      { common:"FASTEN", imposter:"DIÄT" },
      { common:"MOSCHEE", imposter:"MUSEUM" },
      { common:"ZAKAT", imposter:"STEUER" },
      { common:"RAMADAN", imposter:"SHAWWAL" },
    ];

    // Allgemeine (auch kniffligere) Paare:
    const TOPICS_GENERAL = [
      { common:"PIZZA", imposter:"FLAMMKUCHEN" },
      { common:"STRAND", imposter:"SEE" },
      { common:"HUND", imposter:"WOLF" },
      { common:"ZUG", imposter:"STRASSENBAHN" },
      { common:"APFEL", imposter:"BIRNE" },
      { common:"FUSSBALL", imposter:"HANDBALL" },
      { common:"BERLIN", imposter:"HAMBURG" },
      { common:"KAFFEE", imposter:"TEE" },
      { common:"WOLKENKRATZER", imposter:"FUNKTURM" },
      { common:"VIOLINE", imposter:"BRATSCHE" },
      { common:"KOMET", imposter:"METEORIT" },
      { common:"SUSHI", imposter:"SASHIMI" },
      { common:"WÜSTE", imposter:"STEPPE" },
      { common:"LAVA", imposter:"MAGMA" }
    ];

    // ---------- State Machine ----------
    const State = { START:'START', LOBBY:'LOBBY', REVEAL:'REVEAL', DISCUSS:'DISCUSS', VOTE:'VOTE', RESULT:'RESULT' };

    let game = {
      state: State.START,
      lang: 'de',
      category: 'general', // 'islamic' | 'general'
      players: [],
      topic: null,
      pool: TOPICS_GENERAL,
      imposterId: null,
      revealIndex: 0,
      discussEndsAt: 0,
      votes: {},
      options: { discussSeconds: 120, rounds: 1 },
      starterId: null
    };

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function now(){ return Date.now(); }
    function t(key, vars={}){
      const str = (i18n[game.lang]?.[key] ?? i18n.de[key] ?? key);
      return str.replace(/\{(\w+)\}/g, (_,k)=> vars[k] ?? '');
    }
    function fmt(s){ const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }

    function setLang(l){
      game.lang = l;
      document.documentElement.lang = l;
      document.body.dir = (l==='ar') ? 'rtl' : 'ltr';
      render();
    }

    function render(){
      const app = $('#app'); app.innerHTML='';

      if (game.state===State.START){
        const c = document.createElement('div'); c.className='card'; app.appendChild(c);
        c.innerHTML = `
          <div class="kicker">${t('start_title')}</div>
          <h2 style="margin:6px 0 0">${t('start_sub')}</h2>
          <div class="row" style="margin-top:14px">
            <div>
              <label>${t('language')}</label>
              <select id="langSel">
                <option value="de">Deutsch</option>
                <option value="en">English</option>
                <option value="ar">العربية</option>
              </select>
            </div>
            <div>
              <label>${t('category')}</label>
              <select id="catSel">
                <option value="islamic">${t('cat_islamic')}</option>
                <option value="general" selected>${t('cat_general')}</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="continueBtn" class="btn">${t('continue')}</button>
          </div>
        `;
        c.querySelector('#langSel').value = game.lang;
        c.querySelector('#langSel').onchange = (e)=> setLang(e.target.value);
        c.querySelector('#catSel').value = game.category;
        c.querySelector('#catSel').onchange = (e)=> {
          game.category = e.target.value;
          game.pool = (game.category==='islamic') ? TOPICS_ISLAMIC : TOPICS_GENERAL;
        };
        c.querySelector('#continueBtn').onclick = ()=> { game.state=State.LOBBY; render(); };
        return;
      }

      if (game.state===State.LOBBY){
        const c = document.createElement('div'); c.className='card'; app.appendChild(c);
        c.innerHTML = `
          <div class="kicker">${t('lobby_title')}</div>
          <div class="muted">${t('players_hint')}</div>

          <label style="margin-top:10px">${t('add_player')}</label>
          <div class="row" style="gap:10px">
            <input id="nameInput" placeholder="${t('name_placeholder')}" />
            <button id="addBtn" class="btn" style="flex:0 0 160px">${t('add_player')}</button>
          </div>

          <div id="players" class="row" style="margin-top:10px"></div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>${t('discussion_secs')}</label>
              <input id="secs" type="number" min="30" max="600" value="${game.options.discussSeconds}">
            </div>
            <div>
              <label>${t('rounds')}</label>
              <input id="rounds" type="number" min="1" max="10" value="${game.options.rounds}">
            </div>
          </div>

          <button id="startBtn" class="btn" style="margin-top:16px" ${game.players.length<3?'disabled':''}>
            ${t('start_game')}
          </button>
        `;
        const bag = c.querySelector('#players');
        game.players.forEach(p=>{
          const tag = document.createElement('div');
          tag.className='player-tag';
          tag.textContent = p.name;
          bag.appendChild(tag);
        });
        c.querySelector('#addBtn').onclick = ()=>{
          const val = c.querySelector('#nameInput').value.trim();
          if(!val) return;
          game.players.push({ id:uid(), name:val });
          render();
        };
        c.querySelector('#secs').onchange = e => game.options.discussSeconds = Math.max(30, Math.min(600, +e.target.value||120));
        c.querySelector('#rounds').onchange = e => game.options.rounds = Math.max(1, Math.min(10, +e.target.value||1));
        c.querySelector('#startBtn').onclick = startGame;
        return;
      }

      if (game.state===State.REVEAL){
        const current = game.players[game.revealIndex];
        const c = document.createElement('div'); c.className='card'; app.appendChild(c);
        c.innerHTML = `
          <div class="kicker">${t('reveal_title')}</div>
          <div class="muted">${t('pass_device_to', {name: current.name})}</div>

          <div class="reveal-wrap" style="margin-top:12px">
            <div class="reveal-content">
              <div class="big" id="wordVal" style="text-align:center">•••</div>
              <div class="pill" id="impTag" style="margin-top:8px; display:none">${t('you_are_imposter')}</div>
            </div>
            <div class="reveal-scrim" id="scrim">
              <div style="width:100%; display:flex; flex-direction:column; align-items:center">
                <div class="scrim-handle"></div>
                <div class="scrim-label">${t('swipe_up')}</div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="doneBtn" class="btn btn-outline">${t('done')}</button>
          </div>
        `;

        // set content
        const isImp = current.id === game.imposterId;
        const word = isImp ? game.topic.imposter : game.topic.common;
        c.querySelector('#wordVal').textContent = word;
        if(isImp) c.querySelector('#impTag').style.display = 'inline-flex';

        // drag-to-reveal
        const scrim = c.querySelector('#scrim');
        let startY = null, curY = 0;
        function setY(y){
          curY = Math.max(-180, Math.min(0, y));
          scrim.style.transform = `translateY(${curY}px)`;
        }
        const onStart = (clientY)=>{ startY = clientY; scrim.style.transition='none'; };
        const onMove = (clientY)=>{
          if(startY===null) return;
          const dy = clientY - startY;
          if (dy < 0) setY(dy); // only upwards
        };
        const onEnd = ()=>{
          scrim.style.transition='transform .18s ease';
          if (curY < -90) setY(-210); else setY(0);
          startY = null;
        };
        scrim.addEventListener('pointerdown', e=>{ scrim.setPointerCapture(e.pointerId); onStart(e.clientY); });
        scrim.addEventListener('pointermove', e=>onMove(e.clientY));
        scrim.addEventListener('pointerup', onEnd);
        scrim.addEventListener('pointercancel', onEnd);

        c.querySelector('#doneBtn').onclick = ()=>{
          game.revealIndex++;
          if (game.revealIndex >= game.players.length){
            // wähle zufälligen Starter
            const startIdx = Math.floor(Math.random()*game.players.length);
            game.starterId = game.players[startIdx].id;
            game.state = State.DISCUSS;
            game.discussEndsAt = now() + game.options.discussSeconds*1000;
          }
          render();
        };
        return;
      }

      if (game.state===State.DISCUSS){
        const c = document.createElement('div'); c.className='card'; app.appendChild(c);
        const starter = game.players.find(p=>p.id===game.starterId);
        const secsLeft = Math.max(0, Math.ceil((game.discussEndsAt - now())/1000));
        c.innerHTML = `
          <div class="kicker">${t('discuss_title')}</div>
          <div class="pill" style="margin-top:8px">${t('starter')}: <b>${starter?.name||'—'}</b></div>
          <p class="muted" style="margin-top:8px">${t('begin_prompt', {name: starter?.name||'—'})}</p>
          <div class="center" style="margin:14px 0">
            <div id="timer" class="big" style="font-variant-numeric:tabular-nums">${fmt(secsLeft)}</div>
          </div>
          <button id="toVoteBtn" class="btn">${secsLeft===0?t('go_vote'):t('early_vote')}</button>
        `;
        const interval = setInterval(()=>{
          if (game.state!==State.DISCUSS) return clearInterval(interval);
          const el = document.getElementById('timer');
          if(!el) return clearInterval(interval);
          const left = Math.max(0, Math.ceil((game.discussEndsAt - now())/1000));
          el.textContent = fmt(left);
          if(left<=0) clearInterval(interval);
        }, 300);
        c.querySelector('#toVoteBtn').onclick = ()=>{ game.state = State.VOTE; render(); };
        return;
      }

      if (game.state===State.VOTE){
        const c = document.createElement('div'); c.className='card'; app.appendChild(c);
        c.innerHTML = `
          <div class="kicker">${t('vote_title')}</div>
          <div id="voteGrid" class="grid" style="margin-top:10px"></div>
          <button id="finishBtn" class="btn" style="margin-top:14px" ${Object.keys(game.votes).length<game.players.length?'disabled':''}>${t('finish_vote')}</button>
        `;
        const grid = c.querySelector('#voteGrid');
        game.players.forEach(voter=>{
          const card = document.createElement('div');
          card.className='card'; card.style.background='#fff';
          card.innerHTML = `
            <div style="font-weight:800;margin-bottom:8px">${voter.name}</div>
            <select id="sel-${voter.id}">
              <option value="">${t('choose_sus')}</option>
              ${game.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}
            </select>
          `;
          grid.appendChild(card);
          const sel = card.querySelector(`#sel-${voter.id}`);
          sel.value = game.votes[voter.id] || '';
          sel.onchange=()=>{
            const v = sel.value;
            if (v===voter.id){ alert("No self-vote."); sel.value=game.votes[voter.id]||''; return; }
            if (v) game.votes[voter.id]=v; else delete game.votes[voter.id];
            document.getElementById('finishBtn').disabled = Object.keys(game.votes).length < game.players.length;
          };
        });
        c.querySelector('#finishBtn').onclick = ()=>{ game.state=State.RESULT; render(); };
        return;
      }

      if (game.state===State.RESULT){
        const c = document.createElement('div'); c.className='card'; app.appendChild(c);
        const tally = {};
        Object.values(game.votes).forEach(pid=>{ if(!pid) return; tally[pid]=(tally[pid]||0)+1; });
        const entries = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
        const accusedId = (entries[0] && entries[1] && entries[0][1]===entries[1][1]) ? null : (entries[0]?.[0] || null);
        const accused = game.players.find(p=>p.id===accusedId);
        const imp = game.players.find(p=>p.id===game.imposterId);
        const win = accusedId===game.imposterId ? t('crew_wins') : t('imposter_wins');

        c.innerHTML = `
          <div class="kicker">${t('result_title')}</div>
          <h2 style="margin:6px 0 10px">${win}</h2>
          <div class="row">
            <div class="pill">Crew: <b>${game.topic.common}</b></div>
            <div class="pill">Imposter: <b>${game.topic.imposter}</b></div>
          </div>
          <div class="card" style="margin-top:12px;background:#fff">
            <div><b>${t('accused')}:</b> ${accused ? accused.name : '—'}</div>
            <div><b>${t('imposter')}:</b> ${imp?.name||'—'}</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="againBtn" class="btn">${t('play_again')}</button>
            <button id="resetBtn" class="btn btn-outline">${t('new_lobby')}</button>
          </div>
        `;
        c.querySelector('#againBtn').onclick=()=>{ nextRound(); render(); };
        c.querySelector('#resetBtn').onclick=()=>{ game = { ...game, state:State.START, players:[], votes:{}, topic:null, imposterId:null, starterId:null, revealIndex:0 }; render(); };
        return;
      }
    }

    function startGame(){
      if (game.players.length<3) return;
      // Thema aus gewähltem Pool
      const pool = game.pool.length ? game.pool : TOPICS_GENERAL;
      game.topic = pool[Math.floor(Math.random()*pool.length)];
      // Imposter bestimmen
      const impIndex = Math.floor(Math.random()*game.players.length);
      game.imposterId = game.players[impIndex].id;
      game.revealIndex = 0;
      game.votes = {};
      game.state = State.REVEAL;
      render();
    }

    function nextRound(){
      const pool = game.pool.length ? game.pool : TOPICS_GENERAL;
      game.topic = pool[Math.floor(Math.random()*pool.length)];
      const impIndex = Math.floor(Math.random()*game.players.length);
      game.imposterId = game.players[impIndex].id;
      game.revealIndex = 0; game.votes = {}; game.state = State.REVEAL;
    }

    // init
    setLang('de'); // default
    render();
  })();
  </script>
</body>
</html>
